<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DandikGPT | Dandik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Space Mono', monospace; background-color: #111827; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; fill: #FCD34D; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .markdown-content pre { background: #1f2937; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; border: 1px solid #374151; }
        
        /* AKTİF SOHBET SARI RENK VE VURGU */
        .active-chat { 
            border-left: 4px solid #FCD34D !important; 
            background-color: rgba(252, 211, 77, 0.1) !important; 
            color: #FCD34D !important; 
            font-weight: bold;
            box-shadow: inset 0 0 20px rgba(252, 211, 77, 0.05);
        }
        .active-chat i { color: #FCD34D !important; opacity: 1 !important; }
    </style>
</head>
<body class="text-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#111827] p-4">
        <div class="w-full max-w-md bg-gray-900 p-8 rounded-3xl border border-gray-800 shadow-2xl relative overflow-hidden text-center transition-all duration-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-yellow-500"></div>
            <i class="fas fa-lock text-4xl text-yellow-500 mb-4"></i>
            <h1 class="text-3xl font-bold mb-8">DandikGPT Giriş</h1>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="E-posta" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-yellow-500 transition-colors">
                <input type="password" id="password" placeholder="Şifre" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-yellow-500 transition-colors">
                <div class="flex gap-2">
                    <button id="login-btn" class="flex-1 bg-yellow-500 text-gray-900 font-bold py-3 rounded-xl hover:bg-yellow-400 transition-all active:scale-95">Giriş</button>
                    <button id="register-btn" class="flex-1 border border-gray-700 font-bold py-3 rounded-xl hover:bg-gray-800 transition-all active:scale-95 text-gray-400">Kayıt</button>
                </div>
                <div class="py-2 text-xs text-gray-600 uppercase font-bold tracking-widest">veya</div>
                <button id="google-login-btn" class="w-full flex items-center justify-center gap-3 bg-white text-gray-900 py-3 rounded-xl font-bold hover:bg-gray-100 transition-all active:scale-95 shadow-lg">
                    <i class="fab fa-google text-red-500"></i> Google ile Devam Et
                </button>
            </div>
            <p id="login-error" class="hidden text-red-500 text-[10px] mt-6 font-bold font-mono p-2 bg-red-500/10 rounded-lg border border-red-500/20"></p>
        </div>
    </div>

    <!-- APP INTERFACE -->
    <div id="app-interface" class="flex-1 flex overflow-hidden hidden opacity-0 transition-opacity duration-500">
        <aside id="sidebar" class="hidden md:flex w-72 flex-col bg-gray-900 border-r border-gray-800 h-full shadow-2xl">
            <div class="p-6">
                <button id="new-chat-btn" class="flex items-center justify-center gap-3 w-full py-4 rounded-xl border border-gray-700 text-yellow-500 font-bold text-sm hover:bg-gray-800 transition-all shadow-lg active:scale-95">
                    <i class="fas fa-plus"></i> Yeni Sohbet
                </button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-1 scrollbar-hide"></div>
            <div class="p-4 border-t border-gray-800 bg-gray-900/50 flex items-center justify-between">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-9 h-9 rounded-xl bg-yellow-500 flex items-center justify-center text-gray-900 font-bold shadow-lg" id="user-initial">?</div>
                    <div class="overflow-hidden">
                        <div id="user-display" class="text-[10px] font-bold truncate text-gray-400">...</div>
                        <div class="text-[8px] text-green-500 font-bold uppercase tracking-tighter">Oturum Aktif</div>
                    </div>
                </div>
                <button id="logout-btn" class="text-gray-500 hover:text-red-400 p-2 transition-colors"><i class="fas fa-power-off"></i></button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-[#111827]">
            <header class="flex items-center justify-between p-4 border-b border-gray-800 bg-gray-900/50 z-10 backdrop-blur-md">
                <div class="flex items-center gap-3">
                    <button id="open-sidebar-btn" class="md:hidden p-2 text-gray-400 hover:bg-gray-800 rounded-lg"><i class="fas fa-bars"></i></button>
                    <span class="font-bold text-yellow-500 text-lg tracking-tight">DandikGPT</span>
                </div>
                <div class="flex items-center gap-2">
                    <div id="status-badge" class="text-[9px] text-gray-500 font-bold uppercase tracking-tighter border border-gray-500/20 bg-gray-500/5 px-3 py-1.5 rounded-full flex items-center gap-2">
                        <div id="status-dot" class="w-1.5 h-1.5 bg-gray-500 rounded-full"></div>
                        <span id="status-text">Bağlanıyor...</span>
                    </div>
                    <span class="text-[9px] text-gray-600 font-bold font-mono px-2 py-1 bg-gray-800 rounded-md border border-gray-700">v0.0.2</span>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto pt-4 pb-36 px-4 md:px-0 scrollbar-hide scroll-smooth">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center px-4 opacity-50">
                    <div class="w-20 h-20 bg-gray-800/50 rounded-3xl flex items-center justify-center mb-6 border border-gray-700 shadow-2xl">
                        <i class="fas fa-robot text-4xl text-yellow-500"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white mb-2">Nasıl Yardımcı Olabilirim?</h1>
                </div>
                <div id="messages-wrapper" class="w-full max-w-3xl mx-auto space-y-0 hidden"></div>
                <div id="loading-indicator" class="hidden w-full max-w-3xl mx-auto px-4 py-8">
                    <div class="flex gap-5 items-start">
                        <div class="w-9 h-9 rounded-xl bg-green-500/10 flex items-center justify-center text-green-500 border border-green-500/20 shadow-lg"><i class="fas fa-robot text-sm"></i></div>
                        <div class="flex flex-col gap-2 pt-1">
                            <span id="queue-text" class="text-[10px] text-yellow-500 font-bold uppercase tracking-widest">Sıraya alınıyor...</span>
                            <div class="flex gap-1">
                                <div class="w-1.5 h-1.5 rounded-full bg-gray-600 animate-bounce"></div>
                                <div class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-bounce [animation-delay:0.2s]"></div>
                                <div class="w-1.5 h-1.5 rounded-full bg-gray-600 animate-bounce [animation-delay:0.4s]"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 w-full bg-gradient-to-t from-[#111827] via-[#111827] to-transparent pt-12 pb-8 px-4 z-10">
                <div class="w-full max-w-3xl mx-auto relative group">
                    <div class="relative flex items-end w-full p-4 bg-[#1f2937] rounded-2xl border border-gray-700 shadow-2xl focus-within:border-yellow-500/50 transition-all duration-300">
                        <textarea id="prompt-input" rows="1" placeholder="Mesaj girin..." class="w-full bg-transparent text-white border-0 focus:ring-0 resize-none max-h-48 py-1 pr-12 scrollbar-hide text-sm md:text-base leading-relaxed"></textarea>
                        <button id="send-btn" class="absolute right-4 bottom-4 p-2.5 rounded-xl bg-yellow-500 text-gray-900 disabled:opacity-30 transition-all hover:scale-105 active:scale-95 shadow-lg" disabled><i class="fas fa-paper-plane text-sm"></i></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDfb06u3InSjQLNOSbpNsu6isjGWIR1qg0",
            authDomain: "dandikgpt.firebaseapp.com",
            projectId: "dandikgpt",
            storageBucket: "dandikgpt.firebasestorage.app",
            messagingSenderId: "858020141627",
            appId: "1:858020141627:web:e770d0675a22c823d15a1e"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "dandikgpt";

        const API_URL = "https://api.dandik.tech:8443/chat";
        const HEARTBEAT_URL = "https://api.dandik.tech:8443/"; 
        
        let currentChatId = null;
        let activeChatUrl = null;
        let historyUnsub = null;

        const ui = {
            login: document.getElementById('login-screen'),
            app: document.getElementById('app-interface'),
            email: document.getElementById('email'),
            pass: document.getElementById('password'),
            error: document.getElementById('login-error'),
            history: document.getElementById('history-list'),
            messages: document.getElementById('messages-wrapper'),
            input: document.getElementById('prompt-input'),
            send: document.getElementById('send-btn'),
            queue: document.getElementById('queue-text'),
            loader: document.getElementById('loading-indicator'),
            welcome: document.getElementById('welcome-screen'),
            container: document.getElementById('chat-container'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            statusBadge: document.getElementById('status-badge')
        };

        // --- BACKEND DURUM KONTROLÜ ---
        async function checkBackend() {
            try {
                // Sunucunun / rotasına basit bir fetch atıyoruz
                const res = await fetch(HEARTBEAT_URL, { mode: 'no-cors' });
                ui.statusText.innerText = "Sunucu Aktif";
                ui.statusText.className = "text-green-500";
                ui.statusDot.className = "w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse";
                ui.statusBadge.className = ui.statusBadge.className.replace('border-gray-500/20', 'border-green-500/20').replace('bg-gray-500/5', 'bg-green-500/5');
            } catch (e) {
                ui.statusText.innerText = "Sunucu Çevrimdışı";
                ui.statusText.className = "text-red-500";
                ui.statusDot.className = "w-1.5 h-1.5 bg-red-500 rounded-full";
                ui.statusBadge.className = ui.statusBadge.className.replace('border-green-500/20', 'border-red-500/20').replace('bg-green-500/5', 'bg-red-500/5');
            }
        }
        setInterval(checkBackend, 10000); // 10 saniyede bir kontrol et
        checkBackend();

        // --- AUTH ---
        document.getElementById('register-btn').onclick = () => {
            auth.createUserWithEmailAndPassword(ui.email.value, ui.pass.value).catch(e => {
                ui.error.innerText = e.message; ui.error.classList.remove('hidden');
            });
        };
        document.getElementById('login-btn').onclick = () => {
            auth.signInWithEmailAndPassword(ui.email.value, ui.pass.value).catch(e => {
                ui.error.innerText = e.message; ui.error.classList.remove('hidden');
            });
        };
        document.getElementById('google-login-btn').onclick = () => {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => {
                ui.error.innerText = e.message; ui.error.classList.remove('hidden');
            });
        };
        document.getElementById('logout-btn').onclick = () => auth.signOut().then(() => location.reload());

        auth.onAuthStateChanged(user => {
            if (user) {
                ui.login.classList.add('hidden');
                ui.app.classList.remove('hidden');
                setTimeout(() => ui.app.classList.add('opacity-100'), 50);
                document.getElementById('user-display').innerText = user.email || user.displayName;
                document.getElementById('user-initial').innerText = (user.email || 'D')[0].toUpperCase();
                startHistory(user.uid);
                startNewChat();
            }
        });

        // --- HISTORY & SYNC ---
        function startHistory(userId) {
            if (historyUnsub) historyUnsub();
            historyUnsub = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('chats')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snap => {
                    ui.history.innerHTML = '<div class="px-2 py-1 text-[9px] font-bold text-gray-600 mt-2 uppercase tracking-widest mb-4">Sohbet Geçmişin</div>';
                    snap.forEach(doc => {
                        const data = doc.data();
                        const isActive = currentChatId === doc.id;
                        
                        if (isActive && data.chatUrl) activeChatUrl = data.chatUrl;

                        const btn = document.createElement('button');
                        btn.className = `w-full text-left px-4 py-3.5 rounded-xl text-xs truncate transition-all mb-2 flex items-center gap-3 ${isActive ? 'active-chat shadow-xl' : 'text-gray-500 hover:bg-gray-800 hover:text-gray-300'}`;
                        btn.innerHTML = `<i class="fas fa-comment-dots opacity-40 text-[10px]"></i> ${data.title || 'Yeni Sohbet'}`;
                        btn.onclick = () => loadChat(doc.id, data.chatUrl);
                        ui.history.appendChild(btn);
                    });
                });
        }

        async function loadChat(id, url) {
            if (currentChatId === id) return;
            currentChatId = id; 
            activeChatUrl = url;
            ui.messages.innerHTML = ''; 
            ui.welcome.classList.add('hidden');
            ui.messages.classList.remove('hidden');
            
            const msgs = await db.collection('artifacts').doc(appId).collection('users').doc(auth.currentUser.uid).collection('chats').doc(id).collection('messages').orderBy('timestamp', 'asc').get();
            msgs.forEach(m => addMessage(m.data().role, m.data().text, false));
            
            startHistory(auth.currentUser.uid);
        }

        function startNewChat() {
            currentChatId = "c_" + Date.now(); 
            activeChatUrl = null;
            ui.messages.innerHTML = ''; 
            ui.welcome.classList.remove('hidden');
            ui.messages.classList.add('hidden');
            startHistory(auth.currentUser.uid);
        }

        document.getElementById('new-chat-btn').onclick = startNewChat;

        // --- CHAT LOGIC ---
        function addMessage(role, text, anim = true) {
            ui.welcome.classList.add('hidden'); 
            ui.messages.classList.remove('hidden');
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `w-full py-8 group transition-all duration-500 ${isUser ? '' : 'bg-[#1f2937]/40 border-y border-gray-800/50 shadow-inner'}`;
            
            const avatar = isUser 
                ? `<div class="w-9 h-9 rounded-xl bg-yellow-500 flex items-center justify-center text-gray-900 font-bold shadow-lg">S</div>`
                : `<div class="w-9 h-9 rounded-xl bg-green-500/10 flex items-center justify-center text-green-500 border border-green-500/20 shadow-lg"><i class="fas fa-robot text-sm"></i></div>`;

            div.innerHTML = `
                <div class="max-w-3xl mx-auto flex gap-6 px-4">
                    <div class="shrink-0 pt-1">${avatar}</div>
                    <div class="markdown-content prose prose-invert text-sm md:text-base flex-1 whitespace-pre-wrap leading-relaxed text-gray-200">${text}</div>
                </div>
            `;
            ui.messages.appendChild(div);
            if (anim) ui.container.scrollTo({ top: ui.container.scrollHeight, behavior: 'smooth' });
            return div.querySelector('.markdown-content');
        }

        async function handleSend() {
            const msg = ui.input.value.trim();
            if (!msg) return;

            const chatId = currentChatId;
            const userId = auth.currentUser.uid;
            const chatUrlAtSend = activeChatUrl;
            
            ui.input.value = ''; ui.input.style.height = 'auto'; ui.send.disabled = true; // CEVAP GELENE KADAR DEAKTİF
            
            addMessage('user', msg);
            await saveToDB(chatId, 'user', msg);

            ui.loader.classList.remove('hidden');
            ui.queue.innerText = "Sıraya bağlanılıyor...";
            ui.container.scrollTo({ top: ui.container.scrollHeight, behavior: 'smooth' });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, chatId, userId, chatUrl: chatUrlAtSend })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botDiv = null;
                let fullRes = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });

                    if (chunk.includes("[QUEUE_POS:")) {
                        const match = chunk.match(/\[QUEUE_POS:(\d+)\]/);
                        if (match) ui.queue.innerText = `Kuyruktasınız: #${match[1]}`;
                        continue;
                    }

                    if (!botDiv) {
                        ui.queue.innerText = "Cevap hazırlanıyor...";
                        botDiv = addMessage('bot', '');
                    }

                    fullRes += chunk;
                    let display = fullRes;
                    
                    if (fullRes.includes("[URL:")) {
                        const m = fullRes.match(/\[URL:(.*?)\]/);
                        if (m) {
                            activeChatUrl = m[1];
                            await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('chats').doc(chatId).update({ chatUrl: activeChatUrl });
                            display = fullRes.replace(/\[URL:.*?\]/, '');
                        }
                    }
                    
                    botDiv.innerText = display;
                    ui.container.scrollTo(0, 99999);
                }
                
                const finalCleanTxt = fullRes.replace(/\[URL:.*?\]/, '');
                if (finalCleanTxt) await saveToDB(chatId, 'bot', finalCleanTxt);

            } catch (err) { 
                addMessage('bot', "Sunucu Hatası: Bağlantı kurulamadı."); 
            } finally { 
                ui.loader.classList.add('hidden'); 
                ui.send.disabled = false; // CEVAP BİTİNCE AKTİF
                ui.input.focus();
            }
        }

        async function saveToDB(id, role, text) {
            const userId = auth.currentUser.uid;
            const chatRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('chats').doc(id);
            const doc = await chatRef.get();
            if (!doc.exists) {
                await chatRef.set({ 
                    title: text.substring(0, 30) + (text.length > 30 ? '...' : ''), 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
                    chatUrl: activeChatUrl 
                });
            }
            await chatRef.collection('messages').add({ role, text, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        }

        ui.input.oninput = function() { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; if (!ui.loader.classList.contains('hidden')) ui.send.disabled = true; else ui.send.disabled = !this.value.trim(); };
        ui.input.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (!ui.send.disabled) handleSend(); } };
        ui.send.onclick = handleSend;
        document.getElementById('open-sidebar-btn').onclick = () => document.getElementById('sidebar').classList.toggle('hidden');
    </script>
</body>
</html>
