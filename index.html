console.log("âš™ï¸ Cloudflare Origin CA (GerÃ§ek SSL) Sunucusu BaÅŸlatÄ±lÄ±yor..."); 

const express = require('express');
const https = require('https');
const puppeteer = require('puppeteer-extra');
const StealthPlugin = require('puppeteer-extra-plugin-stealth');
const bodyParser = require('body-parser');
const path = require('path');
const cors = require('cors');
const fs = require('fs'); 

puppeteer.use(StealthPlugin());

const app = express();

// --- SERTÄ°FÄ°KA YÃœKLEME ---
// Cloudflare panelinden aldÄ±ÄŸÄ±n dosyalar burada okunur.
let pems = {};
try {
    pems.private = fs.readFileSync('origin_key.pem', 'utf8');
    pems.cert = fs.readFileSync('origin_cert.pem', 'utf8');
    console.log("âœ… Sertifikalar BaÅŸarÄ±yla Okundu!");
} catch (e) {
    console.log("âŒ KRÄ°TÄ°K HATA: Sertifika dosyalarÄ± bulunamadÄ±!");
    console.log("ðŸ‘‰ LÃ¼tfen 'origin_key.pem' ve 'origin_cert.pem' dosyalarÄ±nÄ±n bu klasÃ¶rde olduÄŸundan emin ol.");
    process.exit(1);
}

app.set('trust proxy', true);

// --- DETAYLI LOGLAMA ---
app.use((req, res, next) => {
    console.log(`\nðŸ”” [${new Date().toLocaleTimeString()}] Ä°STEK GELDÄ°`);
    const origin = req.headers.origin || 'Belirsiz';
    console.log(`   ðŸ“ Kaynak: ${origin}`);
    console.log(`   ðŸ“¨ URL: ${req.method} ${req.url}`);
    next();
});

// --- CORS AYARLARI ---
app.use((req, res, next) => {
    const origin = req.headers.origin;
    if (origin && origin !== 'null') {
        res.header('Access-Control-Allow-Origin', origin);
        res.header('Access-Control-Allow-Credentials', 'true');
    } else {
        res.header('Access-Control-Allow-Origin', '*');
    }
    
    res.header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    
    if (req.method === 'OPTIONS') return res.sendStatus(200);
    next();
});

app.use(bodyParser.json());

app.get('/', (req, res) => res.send("<h1>ðŸš€ Dandik API v2.0 (HTTPS) Ã‡alÄ±ÅŸÄ±yor!</h1>"));

let browser;
let page;

async function initBrowser() {
    console.log("ðŸ¦Š Firefox BaÅŸlatÄ±lÄ±yor...");
    try {
        browser = await puppeteer.launch({ 
            product: 'firefox', 
            headless: false, // Ä°lk giriÅŸte false kalsÄ±n
            ignoreHTTPSErrors: true, 
            userDataDir: path.join(__dirname, 'user_data_firefox_https'), 
            defaultViewport: null,
            timeout: 60000, 
            dumpio: false, 
            args: ['--start-maximized', '--no-remote', '--wait-for-browser']
        });
        page = await browser.newPage();
        console.log("ðŸŒ ChatGPT'ye gidiliyor...");
        await page.goto('https://chatgpt.com', { waitUntil: 'domcontentloaded', timeout: 90000 });
        console.log("âœ… Firefox HazÄ±r! (LÃ¼tfen giriÅŸ yap)");
    } catch (e) {
        console.log("âŒ TarayÄ±cÄ± BaÅŸlatma HatasÄ±:", e.message);
    }
}

app.post('/chat', async (req, res) => {
    const userMessage = req.body.message;
    console.log(`ðŸ“© MESAJ: "${userMessage}"`);

    if (!page) return res.status(500).json({ reply: "Sunucu (TarayÄ±cÄ±) henÃ¼z hazÄ±r deÄŸil." });

    try {
        const textareaSelector = '#prompt-textarea';
        const sendButtonSelector = 'button[data-testid="send-button"]'; 

        // 1. Sayfa veya Input HazÄ±r mÄ±?
        try {
            await page.waitForSelector(textareaSelector, { timeout: 5000 });
        } catch (e) {
            console.log("âš ï¸ Input bulunamadÄ±, sayfa yenileniyor...");
            await page.reload({ waitUntil: 'domcontentloaded' });
            await page.waitForSelector(textareaSelector, { timeout: 10000 });
        }

        // 2. Input Temizleme (React Uyumlu)
        // Ã–nceki mesajÄ±n kalÄ±ntÄ±larÄ±nÄ± temizler
        await page.evaluate((selector) => {
            const input = document.querySelector(selector);
            if (input) {
                input.focus();
                input.value = '';
                // React state'ini gÃ¼ncellemek iÃ§in olay tetikle
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }, textareaSelector);

        // 3. MesajÄ± Yaz
        await page.type(textareaSelector, userMessage, { delay: 10 });
        
        await new Promise(r => setTimeout(r, 500)); 

        // 4. GÃ¶nderme Ä°ÅŸlemi (Buton veya Enter)
        const btnClicked = await page.evaluate((btnSel) => {
            const btn = document.querySelector(btnSel);
            if (btn && !btn.disabled) {
                btn.click();
                return true;
            }
            return false;
        }, sendButtonSelector);

        if (!btnClicked) {
            console.log("   ðŸ‘‰ Buton bulunamadÄ±, Enter tuÅŸuna basÄ±lÄ±yor...");
            await page.keyboard.press('Enter');
        } else {
            console.log("   ðŸ‘‰ GÃ¶nder butonuna tÄ±klandÄ±.");
        }

        console.log("â³ Cevap bekleniyor...");
        // Cevap iÃ§in bekleme sÃ¼resi (15 saniye)
        await new Promise(r => setTimeout(r, 15000)); 

        // 5. CevabÄ± Al
        const response = await page.evaluate(() => {
            const elements = document.querySelectorAll('.markdown');
            if (elements.length > 0) {
                return elements[elements.length - 1].innerText;
            }
            return null; 
        });

        if (response) {
            console.log(`ðŸ“¤ CEVAP (${response.length} karakter): BaÅŸarÄ±lÄ±.`);
            res.json({ reply: response });
        } else {
            console.log("âš ï¸ UYARI: Cevap alÄ±namadÄ± (BoÅŸ veya sÃ¼re yetmedi).");
            res.json({ reply: "ChatGPT cevap vermedi veya sÃ¼re yetmedi. Tekrar dener misin?" });
        }

    } catch (error) {
        console.error("âŒ Ä°ÅŸlem HatasÄ±:", error.message);
        // Kritik hata durumunda sayfayÄ± yenile ki sonraki istekler Ã§alÄ±ÅŸsÄ±n
        try { await page.reload({ waitUntil: 'domcontentloaded' }); } catch(e){}
        res.status(500).json({ reply: `Hata oluÅŸtu, sistemi yeniledim. LÃ¼tfen tekrar yaz.` });
    }
});

// CLOUDFLARE HTTPS PORTU: 8443
https.createServer({ key: pems.private, cert: pems.cert }, app).listen(8443, '0.0.0.0', async () => {
    console.log('------------------------------------------------');
    console.log(`ðŸ”¥ GÃœVENLÄ° SUNUCU AÃ‡IK: https://localhost:8443`);
    console.log('------------------------------------------------');
    await initBrowser();
});
