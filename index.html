<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DandikGPT | macOS Glass</title>
    
    <!-- Scripts & Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fontlar: SF Pro benzeri Inter ve Başlıklar için Space Grotesk -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            /* macOS Tarzı Cam Değişkenleri */
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-blur: blur(25px);
            --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --accent-color: #0A84FF; /* macOS Blue */
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #000; 
            color: var(--text-primary);
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- MAC OS STYLE LIQUID BACKGROUND --- */
        .liquid-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: #0f0c29;
            overflow: hidden;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }

        .orb-1 { width: 60vw; height: 60vw; background: #302b63; top: -10%; left: -10%; animation-duration: 25s; }
        .orb-2 { width: 50vw; height: 50vw; background: #24243e; bottom: -10%; right: -10%; animation-delay: -5s; }
        .orb-3 { width: 40vw; height: 40vw; background: #7c3aed; top: 40%; left: 40%; opacity: 0.3; animation-duration: 35s; filter: blur(100px); }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- GLASSMORPHISM UTILS --- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
        }

        .glass-sidebar {
            background: rgba(20, 20, 30, 0.4);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* --- MESSAGE BUBBLES (iMessage/Instagram Style) --- */
        .message-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
            margin-bottom: 16px;
        }

        .bubble {
            max-width: 85%;
            padding: 12px 18px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }

        .bubble-user {
            /* Kullanıcı: Canlı Gradient */
            background: linear-gradient(135deg, #3a86ff 0%, #302b63 100%);
            color: #fff;
            border-radius: 20px 20px 4px 20px;
            align-self: flex-end;
            box-shadow: 0 4px 15px rgba(58, 134, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bubble-bot {
            /* Bot: Buzlu Cam */
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
            border-radius: 20px 20px 20px 4px;
            align-self: flex-start;
        }

        /* --- CODE BLOCKS --- */
        .code-container {
            background: #1e1e1e; /* Koyu editör rengi */
            border-radius: 12px;
            margin: 10px 0;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Space Mono', monospace;
        }
        .code-header {
            background: #252526;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #9ca3af;
            border-bottom: 1px solid #333;
        }
        .code-content {
            padding: 12px;
            overflow-x: auto;
            font-size: 13px;
            color: #d4d4d4;
            display: block;
        }

        /* --- INPUT AREA (Floating Dock Style) --- */
        .input-dock {
            background: rgba(30, 30, 40, 0.6);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .input-dock:focus-within {
            background: rgba(40, 40, 50, 0.8);
            border-color: rgba(58, 134, 255, 0.4);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
        }

        /* --- SIDEBAR & MOBILE --- */
        #sidebar {
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 50;
        }
        
        .sidebar-open #sidebar { transform: translateX(0); }
        .sidebar-closed #sidebar { transform: translateX(-100%); }

        @media (min-width: 768px) {
            #sidebar { 
                transform: translateX(0) !important; 
                position: relative !important; 
            }
            #mobile-overlay { display: none !important; }
        }

        /* Aktif Sohbet Göstergesi */
        .active-chat {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid #3a86ff;
            color: #fff;
        }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; fill: #a1a1aa; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0.4); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }

        /* Safe Area for modern phones */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe { padding-top: env(safe-area-inset-top, 20px); }
    </style>
</head>
<body class="text-gray-100 h-screen flex flex-col overflow-hidden sidebar-closed selection:bg-blue-500 selection:text-white">

    <!-- Background -->
    <div class="liquid-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- Mobil Menü Karartma -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300"></div>

    <!-- 1. GİRİŞ EKRANI -->
    <div id="login-screen" class="fixed inset-0 z-[60] flex flex-col items-center justify-center p-6 transition-all duration-700">
        <div class="w-full max-w-sm glass p-8 rounded-3xl relative overflow-hidden text-center transform hover:scale-[1.01] transition-transform duration-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-600"></div>
            
            <div class="mb-8 relative inline-block">
                <div class="absolute inset-0 bg-blue-500 blur-2xl opacity-20 rounded-full"></div>
                <i class="fas fa-robot text-6xl text-white relative z-10 drop-shadow-lg"></i>
            </div>
            
            <h1 class="text-3xl font-bold mb-2 tracking-tight" style="font-family: 'Space Grotesk', sans-serif;">DandikGPT</h1>
            <p class="text-xs text-gray-400 mb-8 uppercase tracking-widest">Liquid Glass Edition</p>
            
            <div class="space-y-4">
                <input type="email" id="email" placeholder="E-posta" class="w-full bg-white/5 border border-white/10 rounded-xl px-5 py-3.5 text-sm outline-none focus:bg-white/10 focus:border-blue-500/50 transition-all text-white placeholder-gray-500">
                <input type="password" id="password" placeholder="Şifre" class="w-full bg-white/5 border border-white/10 rounded-xl px-5 py-3.5 text-sm outline-none focus:bg-white/10 focus:border-blue-500/50 transition-all text-white placeholder-gray-500">
                
                <div class="flex gap-3">
                    <button id="login-btn" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-medium py-3.5 rounded-xl transition-all shadow-lg shadow-blue-500/20 active:scale-95">Giriş</button>
                    <button id="register-btn" class="flex-1 bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300 font-medium py-3.5 rounded-xl transition-all active:scale-95">Kayıt</button>
                </div>
                
                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-white/10"></span></div>
                    <div class="relative flex justify-center text-[10px] uppercase"><span class="bg-[#12121c] px-2 text-gray-500">veya</span></div>
                </div>

                <button id="google-login-btn" class="w-full flex items-center justify-center gap-3 bg-white text-gray-900 py-3.5 rounded-xl font-bold hover:bg-gray-100 transition-all shadow-lg active:scale-95">
                    <i class="fab fa-google text-red-500"></i> Google ile
                </button>
            </div>
            <p id="login-error" class="hidden text-red-400 text-xs mt-6 p-3 bg-red-500/10 rounded-lg border border-red-500/20"></p>
        </div>
    </div>

    <!-- 2. ANA UYGULAMA -->
    <div id="app-interface" class="flex-1 flex overflow-hidden hidden opacity-0 transition-opacity duration-1000">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-72 flex flex-col glass-sidebar h-full z-50 pt-safe">
            <div class="p-6">
                <button id="new-chat-btn" class="flex items-center justify-center gap-2 w-full py-3.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-medium text-sm transition-all shadow-lg shadow-blue-600/20 active:scale-95">
                    <i class="fas fa-plus text-xs"></i> Yeni Sohbet
                </button>
            </div>
            
            <div class="px-6 pb-2">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Geçmiş</h3>
            </div>
            
            <div id="history-list" class="flex-1 overflow-y-auto px-4 pb-4 space-y-1 scrollbar-hide"></div>
            
            <div class="p-4 border-t border-white/5 bg-black/20 backdrop-blur-md pb-safe">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm shadow-inner" id="user-initial">?</div>
                        <div class="overflow-hidden">
                            <div id="user-display" class="text-xs font-medium text-white truncate">...</div>
                            <div class="text-[9px] text-green-400 font-bold uppercase">Online</div>
                        </div>
                    </div>
                    <button id="logout-btn" class="text-gray-400 hover:text-white transition-colors p-2"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </aside>

        <!-- İçerik Alanı -->
        <main class="flex-1 flex flex-col relative min-w-0 h-full">
            
            <!-- Header (Cam) -->
            <header class="absolute top-0 left-0 right-0 z-30 pt-safe px-4 pb-2 bg-black/10 backdrop-blur-md border-b border-white/5 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button id="hamburger-btn" class="md:hidden p-2 text-gray-300 hover:bg-white/10 rounded-lg transition-colors"><i class="fas fa-bars"></i></button>
                    <div class="flex flex-col">
                        <span class="font-bold text-white text-base tracking-tight" style="font-family: 'Space Grotesk', sans-serif;">DandikGPT</span>
                        <div class="flex items-center gap-1.5">
                            <div id="status-dot" class="w-1.5 h-1.5 bg-gray-500 rounded-full"></div>
                            <span id="status-text" class="text-[9px] text-gray-400 font-medium uppercase tracking-wide">Beklemede</span>
                        </div>
                    </div>
                </div>
                <div class="px-3 py-1 bg-white/5 rounded-lg border border-white/5">
                    <span class="text-[10px] text-gray-400 font-mono">v2.0</span>
                </div>
            </header>

            <!-- Chat Alanı -->
            <div id="chat-container" class="flex-1 overflow-y-auto pt-20 pb-32 px-2 md:px-0 scrollbar-hide scroll-smooth">
                
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center px-6 opacity-60">
                    <div class="w-24 h-24 bg-white/5 rounded-[2rem] flex items-center justify-center mb-6 shadow-2xl backdrop-blur-sm border border-white/10">
                        <i class="fas fa-magic text-4xl text-blue-400"></i>
                    </div>
                    <h2 class="text-2xl font-medium text-white mb-2">Nasıl yardımcı olabilirim?</h2>
                    <p class="text-sm text-gray-400 max-w-xs">Kod yazabilirim, soru cevaplayabilirim veya sadece sohbet edebiliriz.</p>
                </div>
                
                <div id="messages-wrapper" class="w-full max-w-3xl mx-auto hidden flex flex-col px-4 pt-4 pb-4"></div>
                
                <!-- Loading Göstergesi -->
                <div id="loading-indicator" class="hidden w-full max-w-3xl mx-auto px-4 py-2 mb-4">
                    <div class="bubble bubble-bot flex items-center gap-3 w-fit">
                        <div class="flex space-x-1">
                            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce [animation-delay:0.4s]"></div>
                        </div>
                        <span id="queue-text" class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Bağlanıyor</span>
                    </div>
                </div>

            </div>

            <!-- Input Alanı (Dock Style) -->
            <div class="absolute bottom-0 left-0 right-0 z-30 pb-safe pt-4 px-4 bg-gradient-to-t from-black via-black/80 to-transparent">
                <div class="w-full max-w-3xl mx-auto mb-4">
                    <div class="input-dock relative flex items-end p-2 pr-3">
                        <textarea id="prompt-input" rows="1" placeholder="Bir şeyler yaz..." class="flex-1 bg-transparent text-white border-0 focus:ring-0 resize-none max-h-40 py-3 px-4 scrollbar-hide text-[15px] placeholder-gray-500"></textarea>
                        <button id="send-btn" class="mb-1 w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center disabled:opacity-30 disabled:bg-gray-700 transition-all hover:scale-105 active:scale-95 shadow-lg shadow-blue-600/20" disabled>
                            <i class="fas fa-arrow-up text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDfb06u3InSjQLNOSbpNsu6isjGWIR1qg0",
            authDomain: "dandikgpt.firebaseapp.com",
            projectId: "dandikgpt",
            storageBucket: "dandikgpt.firebasestorage.app",
            messagingSenderId: "858020141627",
            appId: "1:858020141627:web:e770d0675a22c823d15a1e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "dandikgpt";

        const API_URL = "https://api.dandik.tech:8443/chat";
        const HEARTBEAT_URL = "https://api.dandik.tech:8443/"; 
        
        let currentChatId = null;
        let activeChatUrl = null;
        let historyUnsub = null;
        let isBackendOnline = false;

        const ui = {
            login: document.getElementById('login-screen'),
            app: document.getElementById('app-interface'),
            email: document.getElementById('email'),
            pass: document.getElementById('password'),
            error: document.getElementById('login-error'),
            history: document.getElementById('history-list'),
            messages: document.getElementById('messages-wrapper'),
            input: document.getElementById('prompt-input'),
            send: document.getElementById('send-btn'),
            queue: document.getElementById('queue-text'),
            loader: document.getElementById('loading-indicator'),
            welcome: document.getElementById('welcome-screen'),
            container: document.getElementById('chat-container'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            hamburger: document.getElementById('hamburger-btn'),
            overlay: document.getElementById('mobile-overlay')
        };

        // --- HTML Escape (Güvenlik) ---
        function escapeHTML(str) {
            if (!str) return "";
            return str.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
            });
        }

        // --- Kopyalama Fonksiyonu ---
        window.copyCode = function(btn, id) {
            const code = document.getElementById(id).innerText;
            navigator.clipboard.writeText(code).then(() => {
                const icon = btn.querySelector('i');
                const span = btn.querySelector('span');
                icon.className = 'fas fa-check text-green-400';
                span.innerText = 'Kopyalandı';
                setTimeout(() => {
                    icon.className = 'far fa-copy';
                    span.innerText = 'Kopyala';
                }, 2000);
            });
        }

        // --- Mesaj Ayrıştırıcı (Markdown benzeri) ---
        function parseMessage(text) {
            if (!text) return "";
            
            // 1. Temizlik
            let cleaned = text.replace(/^(?:[a-zA-Z+]+\s+)?Copy code\s*(\n|$)/gmi, '');
            
            // 2. Kod Bloklarını Ayır (```...```)
            const segments = cleaned.split(/(```[\s\S]*?```)/g);
            
            return segments.map(segment => {
                if (segment.startsWith('```') && segment.endsWith('```')) {
                    // Kod Bloğu
                    const match = segment.match(/```(\w*)\n?([\s\S]*?)```/);
                    if (!match) return escapeHTML(segment);
                    
                    const lang = (match[1] || 'text').toLowerCase();
                    const code = match[2].trim();
                    const id = 'code-' + Math.random().toString(36).substr(2, 9);
                    
                    return `
                        <div class="code-container my-3 rounded-lg overflow-hidden border border-white/10 bg-[#0d1117]">
                            <div class="code-header flex justify-between items-center bg-[#21262d] px-4 py-2 text-xs text-gray-400 border-b border-white/5">
                                <span class="font-mono">${lang}</span>
                                <button onclick="copyCode(this, '${id}')" class="flex items-center gap-2 hover:text-white transition-colors">
                                    <i class="far fa-copy"></i> <span>Kopyala</span>
                                </button>
                            </div>
                            <div class="code-content p-4 overflow-x-auto text-sm font-mono text-gray-200">
                                <code id="${id}" class="language-${lang}">${escapeHTML(code)}</code>
                            </div>
                        </div>
                    `;
                } else {
                    // Normal Metin (Satır sonlarını <br> yap)
                    const safeText = escapeHTML(segment).replace(/\n/g, '<br>');
                    return `<span class="whitespace-pre-wrap">${safeText}</span>`;
                }
            }).join('');
        }

        // --- Sidebar & Mobile ---
        function toggleSidebar(open) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            
            if (open) {
                document.body.classList.replace('sidebar-closed', 'sidebar-open');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.add('opacity-100'), 10);
            } else {
                document.body.classList.replace('sidebar-open', 'sidebar-closed');
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }
        ui.hamburger.onclick = () => toggleSidebar(true);
        ui.overlay.onclick = () => toggleSidebar(false);

        // --- Backend Durumu ---
        async function checkBackend() {
            try {
                await fetch(HEARTBEAT_URL, { mode: 'no-cors' });
                isBackendOnline = true;
                ui.statusText.innerText = "Bağlı";
                ui.statusText.className = "text-[9px] font-bold text-green-500 uppercase tracking-widest";
                ui.statusDot.className = "w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#22c55e]";
            } catch (e) {
                isBackendOnline = false;
                ui.statusText.innerText = "Çevrimdışı";
                ui.statusText.className = "text-[9px] font-bold text-red-500 uppercase tracking-widest";
                ui.statusDot.className = "w-1.5 h-1.5 bg-red-500 rounded-full";
            }
        }
        setInterval(checkBackend, 15000);
        checkBackend();

        // --- Auth ---
        auth.onAuthStateChanged(user => {
            if (user) {
                ui.login.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    ui.login.classList.add('hidden');
                    ui.app.classList.remove('hidden');
                    setTimeout(() => ui.app.classList.add('opacity-100'), 50);
                }, 500);
                document.getElementById('user-display').innerText = user.email || "Kullanıcı";
                document.getElementById('user-initial').innerText = (user.email?.[0] || 'D').toUpperCase();
                startHistory(user.uid);
                startNewChat();
            } else {
                ui.app.classList.remove('opacity-100');
                ui.app.classList.add('hidden');
                ui.login.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            }
        });

        document.getElementById('google-login-btn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
        document.getElementById('logout-btn').onclick = () => auth.signOut();

        // --- Geçmiş ---
        function startHistory(userId) {
            if (historyUnsub) historyUnsub();
            historyUnsub = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('chats')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snap => {
                    ui.history.innerHTML = '<div class="px-2 py-3 text-[10px] font-bold text-gray-500 uppercase tracking-widest opacity-60">Arşiv</div>';
                    snap.forEach(doc => {
                        const data = doc.data();
                        const isActive = currentChatId === doc.id;
                        if (isActive && data.chatUrl) activeChatUrl = data.chatUrl;
                        
                        const btn = document.createElement('button');
                        btn.className = `w-full text-left px-4 py-3 rounded-xl text-xs truncate transition-all mb-1 flex items-center gap-3 ${isActive ? 'bg-white/10 text-white font-medium border border-white/10' : 'text-gray-400 hover:bg-white/5 hover:text-gray-200'}`;
                        btn.innerHTML = `<i class="far fa-comment-alt opacity-50"></i> ${data.title || 'Sohbet'}`;
                        btn.onclick = () => { loadChat(doc.id, data.chatUrl); toggleSidebar(false); };
                        ui.history.appendChild(btn);
                    });
                });
        }

        async function loadChat(id, url) {
            if (currentChatId === id) return;
            currentChatId = id; activeChatUrl = url;
            ui.messages.innerHTML = ''; ui.welcome.classList.add('hidden'); ui.messages.classList.remove('hidden');
            
            const msgs = await db.collection('artifacts').doc(appId).collection('users').doc(auth.currentUser.uid).collection('chats').doc(id).collection('messages').orderBy('timestamp', 'asc').get();
            msgs.forEach(m => addMessage(m.data().role, m.data().text, false));
        }

        function startNewChat() {
            currentChatId = "c_" + Date.now(); activeChatUrl = null;
            ui.messages.innerHTML = ''; ui.welcome.classList.remove('hidden'); ui.messages.classList.add('hidden');
        }
        document.getElementById('new-chat-btn').onclick = () => { startNewChat(); toggleSidebar(false); };

        // --- Mesaj Ekleme ---
        function addMessage(role, text, anim = true) {
            ui.welcome.classList.add('hidden'); ui.messages.classList.remove('hidden');
            const isUser = role === 'user';
            
            const div = document.createElement('div');
            div.className = `message-group ${isUser ? 'items-end' : 'items-start'} animate-in fade-in slide-in-from-bottom-2 duration-300`;
            
            const bubble = document.createElement('div');
            bubble.className = `bubble ${isUser ? 'bubble-user' : 'bubble-bot'}`;
            bubble.innerHTML = parseMessage(text);
            
            div.appendChild(bubble);
            ui.messages.appendChild(div);

            // Highlight.js uygula
            bubble.querySelectorAll('pre code').forEach((el) => {
                hljs.highlightElement(el);
            });

            if (anim) ui.container.scrollTo({ top: ui.container.scrollHeight, behavior: 'smooth' });
            return bubble; // Streaming için dönüyoruz
        }

        // --- Gönderme İşlemi ---
        async function handleSend() {
            const msg = ui.input.value.trim();
            if (!msg) return;
            if (!isBackendOnline) { addMessage('bot', "Sunucu şu an çevrimdışı."); return; }

            const chatId = currentChatId;
            const userId = auth.currentUser.uid;
            
            ui.input.value = ''; 
            ui.input.style.height = 'auto'; 
            ui.send.disabled = true;
            
            addMessage('user', msg);
            await saveToDB(chatId, 'user', msg);

            ui.loader.classList.remove('hidden');
            ui.queue.innerText = "Bağlanıyor...";
            ui.container.scrollTo({ top: ui.container.scrollHeight, behavior: 'smooth' });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, chatId, userId, chatUrl: activeChatUrl })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botBubble = null;
                let fullTxt = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });

                    if (chunk.includes("[QUEUE_POS:")) {
                        const pos = chunk.match(/\[QUEUE_POS:(\d+)\]/)[1];
                        ui.queue.innerText = `Sıradasınız: #${pos}`;
                        continue;
                    }

                    if (!botBubble && !chunk.includes("[URL:")) {
                        ui.queue.innerText = "Yazıyor...";
                        botBubble = addMessage('bot', '');
                    }

                    if (botBubble) {
                        fullTxt += chunk;
                        let display = fullResCleaner(fullTxt); // URL vs temizle
                        botBubble.innerHTML = parseMessage(display); // Canlı render
                        ui.container.scrollTo({ top: ui.container.scrollHeight });
                    }
                }
                
                // URL Güncelleme
                if (fullTxt.includes("[URL:")) {
                    const match = fullTxt.match(/\[URL:(.*?)\]/);
                    if (match) {
                        activeChatUrl = match[1];
                        await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('chats').doc(chatId).update({ chatUrl: activeChatUrl });
                    }
                }

                // Final Kayıt
                const cleanFinal = fullResCleaner(fullTxt);
                if (cleanFinal) {
                    // Son kez highlight at
                    if(botDiv) botDiv.querySelectorAll('pre code').forEach((el) => hljs.highlightElement(el));
                    await saveToDB(chatId, 'bot', cleanFinal);
                }

            } catch (err) {
                addMessage('bot', "Bağlantı hatası oluştu.");
            } finally {
                ui.loader.classList.add('hidden');
                ui.send.disabled = false;
                ui.input.focus();
            }
        }

        function fullResCleaner(txt) {
            return txt.replace(/\[URL:.*?\]/g, '').replace(/\[QUEUE_POS:.*?\]/g, '');
        }

        async function saveToDB(id, role, text) {
            const userId = auth.currentUser.uid;
            const chatRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('chats').doc(id);
            const doc = await chatRef.get();
            if (!doc.exists) {
                await chatRef.set({ title: text.substring(0, 30), timestamp: firebase.firestore.FieldValue.serverTimestamp(), chatUrl: activeChatUrl });
            }
            await chatRef.collection('messages').add({ role, text, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        }

        // --- Event Listeners ---
        ui.input.oninput = function() {
            this.style.height = 'auto'; 
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            ui.send.disabled = !this.value.trim();
        };
        
        ui.input.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey && window.innerWidth > 768) {
                e.preventDefault();
                if (!ui.send.disabled) handleSend();
            }
        };

        ui.send.onclick = handleSend;
    </script>
</body>
</html>
