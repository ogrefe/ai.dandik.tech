<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DandikGPT | Liquid Glass DM</title>
    
    <!-- Scripts & Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@200;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.015);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-yellow: #FCD34D;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020202; 
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- LIQUID BACKGROUND --- */
        .liquid-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, #0d0d1a 0%, #020202 100%);
            overflow: hidden;
        }

        .blob {
            position: absolute;
            width: 850px; height: 850px;
            background: linear-gradient(135deg, rgba(252, 211, 77, 0.05) 0%, rgba(59, 130, 246, 0.03) 100%);
            filter: blur(120px);
            border-radius: 50%;
            animation: move 40s infinite alternate cubic-bezier(0.45, 0.05, 0.55, 0.95);
        }

        @keyframes move {
            from { transform: translate(-30%, -30%) rotate(0deg) scale(1); }
            to { transform: translate(40%, 40%) rotate(120deg) scale(1.3); }
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- GLASSMORPHISM --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(60px);
            -webkit-backdrop-filter: blur(60px);
            border: 1px solid var(--glass-border);
        }

        /* --- INSTAGRAM STYLE BUBBLES --- */
        .bubble {
            max-width: 85%;
            padding: 14px 20px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .bubble-user {
            background: linear-gradient(135deg, #fcd34d 0%, #f59e0b 100%);
            color: #000;
            border-radius: 24px 24px 4px 24px;
            align-self: flex-end;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(252, 211, 77, 0.1);
        }

        .bubble-bot {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: #fff;
            border-radius: 24px 24px 24px 4px;
            align-self: flex-start;
        }

        .message-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100%;
        }

        /* SEÇİLİ SOHBET VURGUSU */
        .active-chat { 
            background: rgba(252, 211, 77, 0.05) !important; 
            border: 1px solid rgba(252, 211, 77, 0.25) !important;
            color: var(--accent-yellow) !important; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        #sidebar { transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .sidebar-open #sidebar { transform: translateX(0); }
        .sidebar-closed #sidebar { transform: translateX(-100%); }
        
        @media (min-width: 768px) {
            #sidebar { 
                transform: translateX(0) !important; 
                position: relative !important; 
                background: rgba(255, 255, 255, 0.01);
            }
        }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Floating Input Pod */
        .input-pod {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(45px);
            -webkit-backdrop-filter: blur(45px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 3.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; fill: var(--accent-yellow); }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0.3); opacity: 0.2; } 40% { transform: scale(1.2); opacity: 1; } }

        /* --- CODE BOX STYLES --- */
        .code-container {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin: 12px 0;
            overflow: hidden;
            font-family: 'Space Mono', monospace;
            max-width: 100%;
        }

        .code-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .copy-btn {
            background: rgba(252, 211, 77, 0.1);
            color: var(--accent-yellow);
            border: 1px solid rgba(252, 211, 77, 0.2);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent-yellow);
            color: #000;
        }

        .code-content {
            padding: 16px;
            overflow-x: auto;
            font-size: 13px;
            color: #e2e8f0;
            white-space: pre;
            display: block;
        }

        .markdown-content pre { 
            background: none !important;
            padding: 0 !important;
            border: none !important;
            margin: 0 !important;
        }
    </style>
</head>
<body class="text-gray-100 h-screen flex flex-col overflow-hidden sidebar-closed">

    <!-- Dinamik Likit Arka Plan -->
    <div class="liquid-bg">
        <div class="blob" style="top: -15%; left: -10%;"></div>
        <div class="blob" style="bottom: -15%; right: -5%; animation-delay: -10s; background: linear-gradient(135deg, rgba(59, 130, 246, 0.03) 0%, rgba(147, 51, 234, 0.02) 100%);"></div>
        <div class="blob" style="top: 35%; left: 25%; width: 600px; height: 600px; animation-duration: 50s; opacity: 0.4;"></div>
    </div>

    <!-- Mobil Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/40 z-40 hidden opacity-0 transition-opacity duration-500"></div>

    <!-- 1. GİRİŞ EKRANI -->
    <div id="login-screen" class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-black/80 p-4 transition-all duration-1000">
        <div class="w-full max-w-md glass-panel p-12 rounded-[3.5rem] shadow-2xl relative overflow-hidden text-center">
            <div class="absolute -top-32 -left-32 w-80 h-80 bg-yellow-500/5 blur-[120px] rounded-full"></div>
            <i class="fas fa-robot text-7xl text-yellow-500 mb-10 drop-shadow-[0_0_25px_rgba(252,211,77,0.25)]"></i>
            <h1 class="text-4xl font-extralight mb-12 tracking-tight text-white uppercase">Dandik<span class="font-bold text-yellow-500">GPT</span></h1>
            <div class="space-y-6">
                <input type="email" id="email" placeholder="E-posta" class="w-full bg-white/5 border border-white/5 rounded-2xl px-7 py-5 text-sm outline-none focus:border-yellow-500/30 transition-all text-white placeholder-gray-600 backdrop-blur-md">
                <input type="password" id="password" placeholder="Şifre" class="w-full bg-white/5 border border-white/5 rounded-2xl px-7 py-5 text-sm outline-none focus:border-yellow-500/30 transition-all text-white placeholder-gray-600 backdrop-blur-md">
                <div class="flex gap-4 pt-4">
                    <button id="login-btn" class="flex-1 bg-yellow-500 text-black font-bold py-5 rounded-2xl hover:bg-yellow-400 transition-all active:scale-95 shadow-xl">Giriş</button>
                    <button id="register-btn" class="flex-1 glass-panel font-bold py-5 rounded-2xl text-gray-300 border-white/10">Kayıt</button>
                </div>
                <button id="google-login-btn" class="w-full flex items-center justify-center gap-4 bg-white text-black py-5 rounded-2xl font-bold hover:bg-gray-100 active:scale-95 shadow-2xl transition-all">
                    <i class="fab fa-google text-red-500 text-xl"></i> Google Authentication
                </button>
            </div>
            <p id="login-error" class="hidden text-red-400 text-xs mt-8 font-medium p-4 bg-red-500/5 rounded-2xl border border-red-500/10"></p>
        </div>
    </div>

    <!-- 2. ANA UYGULAMA -->
    <div id="app-interface" class="flex-1 flex overflow-hidden hidden opacity-0 transition-opacity duration-1000">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-72 md:w-80 flex flex-col bg-white/[0.005] backdrop-blur-[60px] border-r border-white/5 h-full z-50">
            <div class="p-8">
                <button id="new-chat-btn" class="flex items-center justify-center gap-3 w-full py-5 rounded-[2rem] glass-panel border-white/10 text-yellow-500 font-bold text-sm active:scale-95 transition-all">
                    <i class="fas fa-edit"></i> Yeni Sohbet
                </button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto px-5 pb-6 space-y-2 scrollbar-hide"></div>
            
            <div class="p-8 border-t border-white/5 bg-black/5 flex items-center justify-between">
                <div class="flex items-center gap-4 overflow-hidden">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center text-black font-black shadow-lg" id="user-initial">?</div>
                    <div class="overflow-hidden text-left">
                        <div id="user-display" class="text-xs font-bold truncate text-white">...</div>
                        <div class="text-[9px] text-green-400 font-black uppercase tracking-tighter opacity-60">Çevrimiçi</div>
                    </div>
                </div>
                <button id="logout-btn" class="p-2 text-gray-600 hover:text-red-400 transition-all"><i class="fas fa-power-off"></i></button>
            </div>
        </aside>

        <!-- İçerik Alanı -->
        <main class="flex-1 flex flex-col relative min-w-0">
            <header class="flex items-center justify-between p-6 z-30 bg-black/10 backdrop-blur-md border-b border-white/5">
                <div class="flex items-center gap-5">
                    <button id="hamburger-btn" class="md:hidden p-3 -ml-2 text-gray-400 hover:bg-white/5 rounded-2xl transition-colors"><i class="fas fa-bars text-xl"></i></button>
                    <div class="flex flex-col">
                        <span class="font-bold text-yellow-500 text-2xl tracking-tighter">Dandik<span class="text-white opacity-80">GPT</span></span>
                        <div class="flex items-center gap-1.5 mt-0.5">
                            <div id="status-dot" class="w-1.5 h-1.5 bg-gray-700 rounded-full"></div>
                            <span id="status-text" class="text-[9px] text-gray-500 font-black uppercase tracking-widest">Sistem Hazır</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span class="hidden sm:inline-block text-[8px] text-gray-500 font-black font-mono px-4 py-2 bg-white/5 rounded-xl border border-white/5 tracking-widest">V0.0.2</span>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto pt-8 pb-48 scrollbar-hide scroll-smooth">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center px-10 opacity-30 transition-all duration-700">
                    <div class="w-28 h-28 glass-panel rounded-full flex items-center justify-center mb-10 shadow-2xl border-white/10">
                        <i class="fas fa-terminal text-6xl text-yellow-500"></i>
                    </div>
                    <h1 class="text-3xl font-extralight text-white mb-4 tracking-tight uppercase">DandikGPT İletişim Portalı</h1>
                    <p class="text-sm text-gray-400 max-w-xs leading-loose">Liquid Glass mimarisi üzerine kurgulanmış, kurumsal standartlarda optimize edilmiş etkileşim deneyimi.</p>
                </div>
                
                <div id="messages-wrapper" class="w-full max-w-2xl mx-auto hidden flex flex-col px-6 gap-6 pb-4"></div>
                
                <div id="loading-indicator" class="hidden w-full max-w-2xl mx-auto px-6 mt-6">
                    <div class="message-group items-start">
                        <div class="bubble bubble-bot flex items-center py-4 px-6">
                            <svg class="w-12 h-6" viewBox="0 0 24 24"><circle class="typing-dot" cx="4" cy="12" r="3"/><circle class="typing-dot" cx="12" cy="12" r="3"/><circle class="typing-dot" cx="20" cy="12" r="3"/></svg>
                        </div>
                        <span id="queue-text" class="text-[8px] text-yellow-500/40 font-black uppercase ml-4 tracking-[0.2em]">Veri İşleniyor</span>
                    </div>
                </div>
            </div>

            <!-- Mesaj Girişi (Instagram Pod) -->
            <div class="absolute bottom-0 w-full bg-gradient-to-t from-black via-black/40 to-transparent pt-24 pb-10 px-4 md:px-12 z-30 pb-safe">
                <div class="w-full max-w-2xl mx-auto">
                    <div class="input-pod relative flex items-center p-3 transition-all duration-500 focus-within:shadow-[0_0_50px_rgba(252,211,77,0.08)]">
                        <div class="flex-1 flex items-end px-4">
                            <textarea id="prompt-input" rows="1" placeholder="Mesajınızı buraya bırakın..." class="w-full bg-transparent text-white border-0 focus:ring-0 resize-none max-h-56 py-3 scrollbar-hide text-base leading-relaxed placeholder-gray-600 font-light"></textarea>
                        </div>
                        <button id="send-btn" class="w-12 h-12 rounded-full text-yellow-500 disabled:opacity-0 transition-all hover:scale-110 active:scale-90 flex items-center justify-center" disabled>
                            <i class="fas fa-paper-plane text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDfb06u3InSjQLNOSbpNsu6isjGWIR1qg0",
            authDomain: "dandikgpt.firebaseapp.com",
            projectId: "dandikgpt",
            storageBucket: "dandikgpt.firebasestorage.app",
            messagingSenderId: "858020141627",
            appId: "1:858020141627:web:e770d0675a22c823d15a1e",
            measurementId: "G-W31825YR7Y"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "dandikgpt";

        const API_URL = "https://api.dandik.tech:8443/chat";
        const HEARTBEAT_URL = "https://api.dandik.tech:8443/"; 
        
        let currentChatId = null;
        let activeChatUrl = null;
        let historyUnsub = null;
        let isBackendOnline = false;

        const ui = {
            login: document.getElementById('login-screen'),
            app: document.getElementById('app-interface'),
            email: document.getElementById('email'),
            pass: document.getElementById('password'),
            error: document.getElementById('login-error'),
            history: document.getElementById('history-list'),
            messages: document.getElementById('messages-wrapper'),
            input: document.getElementById('prompt-input'),
            send: document.getElementById('send-btn'),
            queue: document.getElementById('queue-text'),
            loader: document.getElementById('loading-indicator'),
            welcome: document.getElementById('welcome-screen'),
            container: document.getElementById('chat-container'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            hamburger: document.getElementById('hamburger-btn'),
            overlay: document.getElementById('sidebar-overlay')
        };

        // --- HELPER: HTML Escape & Copy ---
        function escapeHTML(str) {
            if (!str) return "";
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }

        window.copyToClipboard = function(id) {
            const code = document.getElementById('code-' + id).innerText;
            const temp = document.createElement('textarea');
            temp.value = code;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            
            const btn = document.querySelector(`[data-id="${id}"]`);
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Kopyalandı';
            setTimeout(() => { btn.innerHTML = originalText; }, 2000);
        }

        // --- MARKDOWN & CODE BOX PARSER ---
        function formatMessage(text) {
            if (!text) return "";
            
            // Kod bloklarını yakala (``` ... ```)
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
            let formatted = text;
            
            formatted = formatted.replace(codeBlockRegex, (match, lang, code) => {
                const id = Math.random().toString(36).substr(2, 9);
                return `
                    <div class="code-container">
                        <div class="code-header">
                            <span>${lang || 'Kod'}</span>
                            <button class="copy-btn" data-id="${id}" onclick="window.copyToClipboard('${id}')">
                                <i class="far fa-copy"></i> Kopyala
                            </button>
                        </div>
                        <code id="code-${id}" class="code-content">${escapeHTML(code.trim())}</code>
                    </div>
                `;
            });

            // Geri kalan metin için HTML escape ama kod bloklarını koruyarak
            // (Basit bir yaklaşım: Eğer metinde <div class="code-container"> yoksa escape et)
            if (!formatted.includes('<div class="code-container">')) {
                return escapeHTML(formatted);
            }
            
            return formatted;
        }

        function toggleSidebar(open) {
            if (open) {
                document.body.classList.replace('sidebar-closed', 'sidebar-open');
                ui.overlay.classList.remove('hidden');
                setTimeout(() => ui.overlay.classList.add('opacity-100'), 10);
            } else {
                document.body.classList.replace('sidebar-open', 'sidebar-closed');
                ui.overlay.classList.remove('opacity-100');
                setTimeout(() => ui.overlay.classList.add('hidden'), 300);
            }
        }
        ui.hamburger.onclick = () => toggleSidebar(true);
        ui.overlay.onclick = () => toggleSidebar(false);

        async function checkBackend() {
            try {
                await fetch(HEARTBEAT_URL, { mode: 'no-cors' });
                isBackendOnline = true;
                ui.statusText.innerText = "Online";
                ui.statusText.className = "text-green-400 text-[9px] font-black uppercase tracking-widest";
                ui.statusDot.className = "w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse";
            } catch (e) {
                isBackendOnline = false;
                ui.statusText.innerText = "Standby";
                ui.statusText.className = "text-red-400 text-[9px] font-black uppercase tracking-widest";
                ui.statusDot.className = "w-1.5 h-1.5 bg-red-500 rounded-full";
            }
        }
        setInterval(checkBackend, 15000);
        checkBackend();

        document.getElementById('register-btn').onclick = () => {
            auth.createUserWithEmailAndPassword(ui.email.value, ui.pass.value).catch(e => {
                ui.error.innerText = e.message; ui.error.classList.remove('hidden');
            });
        };
        document.getElementById('login-btn').onclick = () => {
            auth.signInWithEmailAndPassword(ui.email.value, ui.pass.value).catch(e => {
                ui.error.innerText = e.message; ui.error.classList.remove('hidden');
            });
        };
        document.getElementById('google-login-btn').onclick = () => {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => {
                ui.error.innerText = e.message; ui.error.classList.remove('hidden');
            });
        };
        document.getElementById('logout-btn').onclick = () => auth.signOut().then(() => location.reload());

        auth.onAuthStateChanged(user => {
            if (user) {
                ui.login.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    ui.login.classList.add('hidden');
                    ui.app.classList.remove('hidden');
                    setTimeout(() => ui.app.classList.add('opacity-100'), 50);
                }, 500);
                document.getElementById('user-display').innerText = user.email || user.displayName;
                document.getElementById('user-initial').innerText = (user.email || 'D')[0].toUpperCase();
                startHistory(user.uid);
                startNewChat();
            }
        });

        function startHistory(userId) {
            if (historyUnsub) historyUnsub();
            historyUnsub = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('chats')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snap => {
                    ui.history.innerHTML = '<div class="px-2 py-3 text-[9px] font-black text-gray-700 mt-2 uppercase tracking-[0.3em] mb-4 opacity-40">Arşiv</div>';
                    snap.forEach(doc => {
                        const data = doc.data();
                        const isActive = currentChatId === doc.id;
                        if (isActive && data.chatUrl) activeChatUrl = data.chatUrl;

                        const btn = document.createElement('button');
                        btn.className = `w-full text-left px-5 py-4 rounded-2xl text-xs truncate transition-all duration-500 flex items-center gap-4 border border-transparent ${isActive ? 'active-chat' : 'text-gray-500 hover:bg-white/5 hover:text-white'}`;
                        btn.innerHTML = `<i class="fas fa-feather opacity-20 text-[10px]"></i> ${data.title || 'Yeni İleti'}`;
                        btn.onclick = () => { loadChat(doc.id, data.chatUrl); toggleSidebar(false); };
                        ui.history.appendChild(btn);
                    });
                });
        }

        async function loadChat(id, url) {
            if (currentChatId === id) return;
            currentChatId = id; activeChatUrl = url;
            ui.messages.innerHTML = ''; ui.welcome.classList.add('hidden'); ui.messages.classList.remove('hidden');
            const msgs = await db.collection('artifacts').doc(appId).collection('users').doc(auth.currentUser.uid).collection('chats').doc(id).collection('messages').orderBy('timestamp', 'asc').get();
            msgs.forEach(m => addMessage(m.data().role, m.data().text, false));
            startHistory(auth.currentUser.uid);
        }

        function startNewChat() {
            currentChatId = "c_" + Date.now(); activeChatUrl = null;
            ui.messages.innerHTML = ''; ui.welcome.classList.remove('hidden'); ui.messages.classList.add('hidden');
            startHistory(auth.currentUser.uid);
        }
        document.getElementById('new-chat-btn').onclick = () => { startNewChat(); toggleSidebar(false); };

        function addMessage(role, text, anim = true) {
            ui.welcome.classList.add('hidden'); ui.messages.classList.remove('hidden');
            const isUser = role === 'user';
            
            const groupDiv = document.createElement('div');
            groupDiv.className = `message-group ${isUser ? 'items-end' : 'items-start'} animate-in fade-in slide-in-from-bottom-4 duration-500`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `bubble ${isUser ? 'bubble-user' : 'bubble-bot'}`;
            
            // Kod bloklarını içeren metni formatla
            bubbleDiv.innerHTML = `<div class="markdown-content prose prose-invert text-inherit whitespace-pre-wrap leading-snug font-normal">${formatMessage(text)}</div>`;
            
            groupDiv.appendChild(bubbleDiv);
            ui.messages.appendChild(groupDiv);
            
            if (anim) ui.container.scrollTo({ top: ui.container.scrollHeight, behavior: 'smooth' });
            return bubbleDiv.querySelector('.markdown-content');
        }

        async function handleSend() {
            const msg = ui.input.value.trim();
            if (!msg) return;
            if (!isBackendOnline) { addMessage('bot', "İletişim motoru şu an Standby modunda."); return; }

            const chatId = currentChatId;
            const userId = auth.currentUser.uid;
            const currentUrl = activeChatUrl;
            
            ui.input.value = ''; ui.input.style.height = 'auto'; ui.send.disabled = true;
            addMessage('user', msg);
            await saveToDB(chatId, 'user', msg);

            ui.loader.classList.remove('hidden');
            ui.queue.innerText = "Sunucuya Bağlanılıyor";
            ui.container.scrollTo({ top: ui.container.scrollHeight, behavior: 'smooth' });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, chatId, userId, chatUrl: currentUrl })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botDiv = null;
                let fullRes = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });

                    if (chunk.includes("[QUEUE_POS:")) {
                        const pos = chunk.match(/\[QUEUE_POS:(\d+)\]/)[1];
                        ui.queue.innerText = `Sıra: ${pos}`;
                        continue;
                    }

                    if (!botDiv && !chunk.includes("[URL:")) {
                        ui.queue.innerText = "Cevap Oluşturuluyor";
                        botDiv = addMessage('bot', '');
                    }

                    if (botDiv) {
                        fullRes += chunk;
                        let display = fullRes;
                        if (fullRes.includes("[URL:")) {
                            const m = fullRes.match(/\[URL:(.*?)\]/);
                            if (m) {
                                activeChatUrl = m[1];
                                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('chats').doc(chatId).update({ chatUrl: activeChatUrl });
                                display = fullRes.replace(/\[URL:.*?\]/, '');
                            }
                        }
                        // Streaming sırasında düz metin olarak escape edip basıyoruz, bittiğinde parse edilecek
                        botDiv.innerHTML = escapeHTML(display);
                        ui.container.scrollTo({ top: ui.container.scrollHeight });
                    }
                }
                const finalTxt = fullRes.replace(/\[URL:.*?\]/, '');
                if (finalTxt) {
                    // İşlem bittiğinde kod bloklarını render et
                    botDiv.innerHTML = formatMessage(finalTxt);
                    await saveToDB(chatId, 'bot', finalTxt);
                }
            } catch (err) { 
                addMessage('bot', "Erişim Hatası: Senkronizasyon kesildi."); 
            } finally { 
                ui.loader.classList.add('hidden'); ui.send.disabled = false; ui.input.focus();
            }
        }

        async function saveToDB(id, role, text) {
            const userId = auth.currentUser.uid;
            const chatRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('chats').doc(id);
            const doc = await chatRef.get();
            if (!doc.exists) {
                await chatRef.set({ title: text.substring(0, 30) + '...', timestamp: firebase.firestore.FieldValue.serverTimestamp(), chatUrl: activeChatUrl });
            }
            await chatRef.collection('messages').add({ role, text, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        }

        ui.input.oninput = function() { 
            this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; 
            ui.send.disabled = !this.value.trim() || !ui.loader.classList.contains('hidden'); 
            ui.send.style.opacity = this.value.trim() ? "1" : "0.2";
        };
        ui.input.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey && window.innerWidth > 768) { e.preventDefault(); if (!ui.send.disabled) handleSend(); } };
        ui.send.onclick = handleSend;
    </script>
</body>
</html>
